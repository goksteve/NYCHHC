CREATE MATERIALIZED VIEW mv_dsrip_tr017_diab_cdw_epic AS
 WITH tmp AS
       (SELECT
         'QCPR' AS source,
         network,
         admission_dt_key,
         NULL AS parent_location_name,
         facility_id,
         facility_name,
         patient_id,
         pat_lname,
         pat_fname,
         mrn,
         NULL AS location_mrn,
         birthdate,
         age,
         apt_suite,
         street_address,
         city,
         state,
         country,
         mailing_code,
         home_phone,
         day_phone,
         pcp,
         visit_id,
         visit_number,
         visit_type_id,
         visit_type,
         admission_dt,
         discharge_dt,
         medicaid_ind,
         payer_group,
         payer_id,
         payer_name,
         plan_id,
         plan_name,
         NULL AS inspayor1,
         NULL AS inspayor2,
         NULL AS inspayor3,
         NULL AS icd10_codes,
         NULL AS diabetic_medication_name,
         comb_ind,
         a1c_ind,
         ldl_ind,
         NULL AS hemoglobin_order_time,
         NULL AS hemoglobin_result_time,
         NULL AS ldl_c_order_time,
         NULL AS ldl_c__result_time,
         last_pcp_visit_dt,
         last_pcp_facility,
         last_pcp_provider,
         last_bh_facility,
         last_bh_visit_dt,
         last_bh_provider_id,
         last_bh_provider,
         'N' AS epic_flag,
         dsrip_report,
         report_dt,
         load_dt,
         ROW_NUMBER() OVER(PARTITION BY network, patient_id ORDER BY admission_dt DESC) cnt
        FROM
         dsrip_tr_017_diab_mon_cdw)
 SELECT
  p.source,
  p.network,
  p.admission_dt_key,
  p.parent_location_name,
  p.facility_id,
  p.facility_name,
  p.patient_id,
  p.pat_lname,
  p.pat_fname,
  p.mrn,
  p.location_mrn,
  p.birthdate,
  p.age,
  p.apt_suite,
  p.street_address,
  p.city,
  p.state,
  p.country,
  p.mailing_code,
  p.home_phone,
  p.day_phone,
  p.pcp,
  p.visit_id,
  p.visit_number,
  p.visit_type_id,
  p.visit_type,
  p.admission_dt,
  p.discharge_dt,
  p.medicaid_ind,
  p.payer_group,
  p.payer_id,
  p.payer_name,
  p.plan_id,
  p.plan_name,
  p.inspayor1,
  p.inspayor2,
  p.inspayor3,
  p.icd10_codes,
  p.diabetic_medication_name,
  p.comb_ind,
  p.a1c_ind,
  p.ldl_ind,
  p.hemoglobin_order_time,
  p.hemoglobin_result_time,
  a1c_calc_value,
  p.ldl_c_order_time,
  p.ldl_c__result_time,
  ldl_calc_value,
  p.last_pcp_visit_dt,
  p.last_pcp_facility,
  p.last_pcp_provider,
  p.last_bh_facility,
  p.last_bh_visit_dt,
  p.last_bh_provider_id,
  p.last_bh_provider,
  p.epic_flag,
  p.dsrip_report,
  p.report_dt,
  p.load_dt
 FROM
  tmp p
  JOIN (
        SELECT
         *
        FROM
         (
          SELECT
           network,
           patient_id,
          -- orig_result_value,
           calc_result_value,
           test_type
          FROM
           dsrip_tr_017_diab_mon_cdw
          WHERE
           report_dt = (SELECT MAX(report_dt) FROM dsrip_tr_017_diab_mon_cdw)
         )
         PIVOT
         (
   --MAX(orig_result_value) AS orig_value,
 MAX(calc_result_value) AS calc_value
          FOR test_type
          IN ('A1C' AS a1c, 'LDL' AS ldl))
       ) r
   ON r.network = p.network AND r.patient_id = p.patient_id
 WHERE
  p.cnt = 1
 UNION ALL
 SELECT
  source,
  NULL AS network,
  TO_NUMBER(TO_CHAR(contactdate, 'YYYYMMDD')) AS admission_dt_key,
  parent_location_name,
  location_id,
  location_name,
  NULL,
  SUBSTR(pat_name, 1, INSTR(pat_name, ',', 1) - 1) AS pat_lname,
  SUBSTR(pat_name, INSTR(pat_name, ',') + 1) AS pat_fname,
  mrn_empi,
  location_mrn,
  birth_date,
  age_years,
  address_line_1,
  address_line_2,
  NULL,
  address_state,
  NULL,
  address_zip,
  home_phone,
  NULL,
  pcp_general_name,
  NULL,
  NULL,
  NULL,
  encounter_type,
  contactdate,
  hospital_discharge_date,
  NULL,
  NULL,
  NULL,
  NULL,
  NULL,
  NULL,
  inspayor1,
  inspayor2,
  inspayor3,
  icd10_codes,
  diabetic_medication_name,
  numr_flag_ldl_c_and_hemo_test,
  NULL,
  NULL,
  hemoglobin_order_time,
  hemoglobin_result_time,
  hemoglobin_result_value,
  ldl_c_order_time,
  ldl_c__result_time,
  ldl_c_result_value,
  last_primary_care_visit_dt,
  last_primary_care_visit_dep_nm,
  NULL,
  last_behav_hlth_visit_dep_nm,
  last_behav_hlth_visit_date,
  NULL,
  last_behav_hlth_visit_prov_nm,
  epic_flag,
  'DSRIP_TR017_DIABETES_MONITORING',
  report_dt,
  etl_load_date
 FROM
  dsrip_tr_017_diab_mon_epic;

GRANT SELECT ON mv_dsrip_tr_017_diab_cdw_epic TO PUBLIC;
/